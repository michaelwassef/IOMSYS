@{
    ViewData["Title"] = "Home Page";
    Layout = "_DevExtremeLayout";
}

<div class="text-center">
    <h1 class="display-4" id="userNameDisplay">Welcome</h1>
</div>

<div class="row">
    <div class="form-group col-md-3 mb-3">
        <label for="branchId">اسم الفرع</label>
        <select id="BranchId" class="form-control"></select>
    </div>
    <div class="form-group col-md-3 mb-3">
        <label for="fromDate">تاريخ التحصيل</label>
        <div id="fromDate"></div>
    </div>
    <div class="form-group col-md-3 mb-3">
        <label for="toDate">تاريخ التحصيل</label>
        <div id="toDate"></div>
    </div>
</div>

<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card shadow bg-success text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-graph-up"></i> اجمالي صافي الربح</h5>
                <p class="card-text display-4" id="profit">0</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-cart-fill bg-primary"></i> اجمالي قيمة المشتريات
                </h5>
                <p class="card-text display-4" id="totalAmountInPurchase">0</p>
                <div class="progress">
                    <div class="progress-bar bg-primary" id="totalAmountInPurchaseProgress" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>

    </div>
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-cart-fill bg-primary"></i> اجمالي المدفوع من قيمة المشتريات
                </h5>
                <p class="card-text display-4" id="paidUpInPurchase">0</p>
                <div class="progress">
                    <div class="progress-bar bg-success" id="paidUpInPurchaseProgress" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-cart-fill bg-primary"></i> اجمالي المتبقي من المشتريات
                </h5>
                <p class="card-text display-4" id="remainderInPurchase">0</p>
                <div class="progress">
                    <div class="progress-bar bg-warning" id="remainderInPurchaseProgress" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-cart-fill"></i> اجمالي قيمة المبيعات</h5>
                <p class="card-text display-4" id="totalAmountInSales">0</p>
                <div class="progress">
                    <div class="progress-bar" id="totalAmountInSalesProgress" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-cart-fill"></i> اجمالي المدفوع من قيمة المبيعات</h5>
                <p class="card-text display-4" id="paidUpInSales">0</p>
                <div class="progress">
                    <div class="progress-bar bg-success" id="paidUpInSalesProgress" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-cart-fill"></i> اجمالي المتبقي من قيمة المبيعات</h5>
                <p class="card-text display-4" id="remainderInSales">0</p>
                <div class="progress">
                    <div class="progress-bar bg-warning" id="remainderInSalesProgress" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function updateProgressBar(progressElementId, value, max) {
        const progressBar = document.getElementById(progressElementId);
        if (progressBar) {
            let percentage = (value / max) * 100;
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', value);
            progressBar.setAttribute('aria-valuemax', max);
        }
    }

    function fetchData(endpoint, params, totalElementId, paidElementId, progressElementId) {
        fetch(endpoint + '?' + new URLSearchParams(params))
            .then(response => response.json())
            .then(data => {
                const totalElement = document.getElementById(totalElementId);
                const paidElement = document.getElementById(paidElementId);
                if (totalElement) {
                    totalElement.innerText = data.total ?? 0;
                }
                if (paidElement) {
                    paidElement.innerText = data.paidUp ?? 0;
                }
                if (progressElementId) {
                    updateProgressBar(progressElementId, data.paidUp, data.total);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function updateDashboard() {
        let fromDate = $("#fromDate").dxDateBox("instance").option("value").toISOString().split('T')[0];
        let toDate = $("#toDate").dxDateBox("instance").option("value").toISOString().split('T')[0];
        let branchId = $("#BranchId").val();

        const params = { fromDate, toDate, BranchId: branchId };

        fetchData('@Url.Action("GetTotalAmountInPurchaseInvoices", "Dashboard")', params, 'totalAmountInPurchase', 'paidUpInPurchase', 'totalAmountInPurchaseProgress');
        fetchData('@Url.Action("GetPaidUpInPurchaseInvoices", "Dashboard")', params, 'paidUpInPurchase', '', 'paidUpInPurchaseProgress');
        fetchData('@Url.Action("GetRemainderInPurchaseInvoices", "Dashboard")', params, 'remainderInPurchase', '', 'remainderInPurchaseProgress');
        fetchData('@Url.Action("GetTotalAmountInSalesInvoices", "Dashboard")', params, 'totalAmountInSales', '', 'totalAmountInSalesProgress');
        fetchData('@Url.Action("GetPaidUpInSalesInvoices", "Dashboard")', params, 'paidUpInSales', '', 'paidUpInSalesProgress');
        fetchData('@Url.Action("GetRemainderInSalesInvoices", "Dashboard")', params, 'remainderInSales', '', 'remainderInSalesProgress');
        fetchData('@Url.Action("CalculateProfit", "Dashboard")', params, 'profit', '', '');
    }



    $(function () {
        $("#fromDate, #toDate").dxDateBox({
            type: "date",
            value: new Date(),
            displayFormat: "yyyy-MM-dd",
            onValueChanged: updateDashboard
        });

        $.getJSON('/Branches/LoadBranchesByUser')
            .then(data => {
                const branchSelect = $('#BranchId');
                data.forEach(branch => {
                    branchSelect.append(new Option(branch.BranchName, branch.BranchId));
                });
                branchSelect.change(updateDashboard);
                updateDashboard();
            })
            .catch(error => console.error('Error fetching branches:', error));

        fetch('/Users/UserOpenSession')
            .then(response => response.text())
            .then(username => {
                document.getElementById('userNameDisplay').innerText = "Welcome " + username;
            })
            .catch(error => console.error('Error fetching username:', error));
    });
</script>