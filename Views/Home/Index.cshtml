@{
    ViewData["Title"] = "Home Page";
    Layout = "_DevExtremeLayout";
}
<link rel="stylesheet" href="~/css/site.css">

<div class="page-title">
    <img src="/logo.png" alt="Logo" height="120" class="d-inline-block align-top">
    <h1 class="display-4" id="userNameDisplay">Welcome</h1>
</div>

<div class="row">
    <div class="form-group col-md-3 mb-3">
        <label for="branchId">اسم الفرع</label>
        <select id="BranchId" class="form-control"></select>
    </div>
    <div class="form-group col-md-3 mb-3">
        <label for="fromDate">من تاريخ</label>
        <div id="fromDate"></div>
    </div>
    <div class="form-group col-md-3 mb-3">
        <label for="toDate">الي تاريخ</label>
        <div id="toDate"></div>
    </div>
    <div class="form-group col-md-3 mb-3">
        <button class="btn btn-primary mt-4" id="todayBtn">تحديث التواريخ لليوم</button>
    </div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card profit-card shadow">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-graph-up icon"></i> اجمالي الربح المتوقع</h5>
                <p class="card-text" id="expectedNet">0</p>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card profit-card shadow">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-graph-up icon"></i> اجمالي صافي الربح</h5>
                <p class="card-text" id="profit">0</p>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-3 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-cart-fill bg-primary"></i> اجمالي قيمة المشتريات
                </h5>
                <p class="card-text display-4" id="totalAmountInPurchase">0</p>
                <div class="progress">
                    <div class="progress-bar bg-primary" id="totalAmountInPurchaseProgress" role="progressbar" style="width: 100%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-cart-fill bg-primary"></i> اجمالي المدفوع من قيمة المشتريات
                </h5>
                <p class="card-text display-4" id="paidUpInPurchase">0</p>
                <div class="progress">
                    <div class="progress-bar bg-success" id="paidUpInPurchaseProgress" role="progressbar" style="width: 100%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-cart-fill bg-primary"></i> اجمالي المتبقي من المشتريات
                </h5>
                <p class="card-text display-4" id="remainderInPurchase">0</p>
                <div class="progress">
                    <div class="progress-bar bg-warning" id="remainderInPurchaseProgress" role="progressbar" style="width: 100%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-cart-fill bg-primary"></i> اجمالي المصروفات
                </h5>
                <p class="card-text display-4" id="ExpensesAmount">0</p>
                <div class="progress">
                    <div class="progress-bar bg-danger" id="ExpensesAmountProgress" role="progressbar" style="width: 100%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>

    </div>
</div>
<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-cart-fill"></i> اجمالي قيمة المبيعات</h5>
                <p class="card-text display-4" id="totalAmountInSales">0</p>
                <div class="progress">
                    <div class="progress-bar" id="totalAmountInSalesProgress" role="progressbar" style="width: 100%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-cart-fill"></i> اجمالي المدفوع من قيمة المبيعات</h5>
                <p class="card-text display-4" id="paidUpInSales">0</p>
                <div class="progress">
                    <div class="progress-bar bg-success" id="paidUpInSalesProgress" role="progressbar" style="width: 100%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-cart-fill"></i> اجمالي المتبقي من قيمة المبيعات</h5>
                <p class="card-text display-4" id="remainderInSales">0</p>
                <div class="progress">
                    <div class="progress-bar bg-warning" id="remainderInSalesProgress" role="progressbar" style="width: 100%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
@*    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-cart-fill"></i> العناصر الأعلى مبيعًا</h5>
                <div id="bestSalesChartContainer" style="height: 400px;"></div>
            </div>
        </div>
    </div>*@
    <div class="col-md-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-cart-fill"></i> اجمالي المبيعات اليومي</h5>
            <div id="dailySalesChartContainer" style="height: 400px;"></div>
        </div>
    </div>
</div>
</div>
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-cart-fill bg-primary"></i> راس المال بسعر الشراء
                </h5>
                <p class="card-text display-4" id="totalbuycost">0</p>
                <div class="progress">
                    <div class="progress-bar bg-primary" id="totalAmountInPurchaseProgress" role="progressbar" style="width: 100%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-cart-fill bg-primary"></i> راس المال بسعر البيع
                </h5>
                <p class="card-text display-4" id="totaldellrevenue">0</p>
                <div class="progress">
                    <div class="progress-bar bg-success" id="paidUpInPurchaseProgress" role="progressbar" style="width: 100%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    function renderBestSalesChart(data) {
        $("#bestSalesChartContainer").dxPieChart({
            dataSource: data,
            series: [{
                argumentField: "ProductName",
                valueField: "TotalSalesQuantity",
                label: {
                    visible: true,
                    connector: {
                        visible: true
                    }
                }
            }],
            legend: {
                visible: true
            },
            tooltip: {
                enabled: true,
                customizeTooltip: function (arg) {
                    return {
                        text: arg.valueText + " عدد المبيعات"
                    };
                }
            }
        });
    }

    function fetchBestSalesData(fromDate, toDate, branchId) {
        const params = { fromDate, toDate, BranchId: branchId };

        fetch('@Url.Action("GetBestSalesAmount", "Dashboard")' + '?' + new URLSearchParams(params))
            .then(response => response.json())
            .then(data => {
                renderBestSalesChart(data);
            })
            .catch(error => console.error('Error:', error));
    }

    function renderDailySalesChart(data) {
        $("#dailySalesChartContainer").dxChart({
            dataSource: data,
            series: {
                argumentField: "SaleDate",
                valueField: "TotalAmount",
                type: "bar",
                color: "#77DD77"
            },
            argumentAxis: {
                label: {
                    format: "shortDate"
                }
            },
            legend: {
                visible: false
            },
            tooltip: {
                enabled: true,
                customizeTooltip: function (arg) {
                    return {
                        text: arg.valueText + " EGP"
                    };
                }
            }
        });
    }

    function fetchDailySalesData(fromDate, toDate, branchId) {
        const params = { fromDate, toDate, BranchId: branchId };

        fetch('@Url.Action("GetDailySalesAmount", "Dashboard")' + '?' + new URLSearchParams(params))
            .then(response => response.json())
            .then(data => {
                renderDailySalesChart(data);
            })
            .catch(error => console.error('Error:', error));
    }

    function updateProgressBar(progressElementId, value, max) {
        const progressBar = document.getElementById(progressElementId);
        if (progressBar) {
            let percentage = (value / max) * 100;
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', value);
            progressBar.setAttribute('aria-valuemax', max);
        }
    }

    function fetchData(endpoint, params, totalElementId, paidElementId, progressElementId) {
        fetch(endpoint + '?' + new URLSearchParams(params))
            .then(response => response.json())
            .then(data => {
                const totalElement = document.getElementById(totalElementId);
                const paidElement = document.getElementById(paidElementId);
                if (totalElement) {
                    totalElement.innerText = data.total ?? 0;
                }
                if (paidElement) {
                    paidElement.innerText = data.paidUp ?? 0;
                }
                if (progressElementId) {
                    updateProgressBar(progressElementId, data.paidUp, data.total);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function fetchDashboardData(fromDate, toDate, branchId) {
        $('#loadingIndicator').show();
        const params = { fromDate, toDate, BranchId: branchId };
        fetch('@Url.Action("GetFinancialDashboard", "Dashboard")' + '?' + new URLSearchParams(params))
            .then(response => response.json())
            .then(data => {
                document.getElementById('totalAmountInPurchase').innerText = data.TotalAmountInPurchaseInvoices ?? 0;
                document.getElementById('paidUpInPurchase').innerText = data.PaidUpInPurchaseInvoices ?? 0;
                document.getElementById('remainderInPurchase').innerText = data.RemainderInPurchaseInvoices ?? 0;
                document.getElementById('totalAmountInSales').innerText = data.TotalAmountInSalesInvoices ?? 0;
                document.getElementById('paidUpInSales').innerText = data.PaidUpInSalesInvoices ?? 0;
                document.getElementById('remainderInSales').innerText = data.RemainderInSalesInvoices ?? 0;
                document.getElementById('ExpensesAmount').innerText = data.ExpensesAmount ?? 0;
                document.getElementById('profit').innerText = data.Profit ?? 0;
                document.getElementById('totalbuycost').innerText = data.TotalBuyCost ?? 0;
                document.getElementById('totaldellrevenue').innerText = data.TotalSellRevenue ?? 0;
                document.getElementById('expectedNet').innerText = data.ExpectedNet ?? 0;
            })
            .catch(error => {
                console.error('Error:', error);
            })
            .finally(() => {
                $('#loadingIndicator').hide();
            });
    }

    function updateDashboard() {
        let fromDate = $("#fromDate").dxDateBox("instance").option("value").toISOString().split('T')[0];
        let toDate = $("#toDate").dxDateBox("instance").option("value").toISOString().split('T')[0];
        let branchId = $("#BranchId").val();

        const params = { fromDate, toDate, BranchId: branchId };
        fetchDashboardData(fromDate, toDate, branchId);
        fetchDailySalesData(fromDate, toDate, branchId);
        fetchBestSalesData(fromDate, toDate, branchId);
    }

    $(function () {
        const today = new Date();
        const lastMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const firstDayOfMonth = new Date(lastMonth.getFullYear(), lastMonth.getMonth(), 1);
        const lastDayOfMonth = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0);

        $("#fromDate").dxDateBox({
            type: "date",
            value: firstDayOfMonth,
            displayFormat: "yyyy-MM-dd",
            onValueChanged: updateDashboard
        });

        $("#toDate").dxDateBox({
            type: "date",
            value: lastDayOfMonth,
            displayFormat: "yyyy-MM-dd",
            onValueChanged: updateDashboard
        });

        $.getJSON('/Branches/LoadBranchesByUser')
            .then(data => {
                const branchSelect = $('#BranchId');
                data.forEach(branch => {
                    branchSelect.append(new Option(branch.BranchName, branch.BranchId));
                });
                branchSelect.change(updateDashboard);
                updateDashboard();
            })
            .catch(error => console.error('Error fetching branches:', error));

        fetch('/Users/UserOpenSession')
            .then(response => response.text())
            .then(username => {
                document.getElementById('userNameDisplay').innerText = "Welcome " + username;
            })
            .catch(error => console.error('Error fetching username:', error));

        $("#todayBtn").on("click", function () {
            updateToDateToday();
        });
    });

    function updateToDateToday() {
        const today = new Date();
        const fromDateInstance = $("#fromDate").dxDateBox("instance");
        const toDateInstance = $("#toDate").dxDateBox("instance");

        fromDateInstance.option("value", today);
        toDateInstance.option("value", today);
        updateDashboard(); // Update the dashboard data
    }
</script>